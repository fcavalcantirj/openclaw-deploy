#!/usr/bin/env bash
# =============================================================================
# claw — Master CLI for managing OpenClaw child instances
# =============================================================================
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/scripts/lib/common.sh"
INSTANCES_DIR="$SCRIPT_DIR/instances"

usage() {
  cat <<EOF
${BOLD}claw — OpenClaw Child Instance Manager${NC}

${BOLD}Usage:${NC}
  claw <command> [args]

${BOLD}Commands:${NC}
  ${GREEN}deploy${NC} --name NAME --bot-token TOKEN   Deploy new child instance
  ${GREEN}import${NC} NAME IP SSH_KEY                  Import existing server
  ${GREEN}list${NC}                                   List all child instances
  ${GREEN}status${NC} NAME                            Show child status
  ${GREEN}approve${NC} NAME CODE                      Approve Telegram pairing
  ${GREEN}message${NC} NAME "text"                    Send message to child
  ${GREEN}logs${NC} NAME [-f]                         View child logs (-f to follow)
  ${GREEN}auth${NC} NAME [--mode oauth|apikey]        Show/switch auth mode
  ${GREEN}restart${NC} NAME                           Restart child gateway
  ${GREEN}destroy${NC} NAME                           Destroy child instance
  ${GREEN}diagnose${NC} NAME|self                      Run health checks (14 checks)
  ${GREEN}fix${NC} NAME                               Fix issues via Solvr, escalate after 3 failures
  ${GREEN}upgrade${NC} NAME [--dry-run]                Upgrade tool stack on child
  ${GREEN}setup-amcp${NC} NAME [--force|--dry-run]     Bootstrap AMCP identity + config + watchdog
  ${GREEN}config${NC} NAME [--show|--set k=v|--push]  View/set AMCP config on child
  ${GREEN}checkpoint${NC} NAME [--full]                Run checkpoint on child
  ${GREEN}shell${NC} NAME                              Interactive Claude Code on child
  ${GREEN}ssh${NC} NAME                               SSH into child (for debugging)

${BOLD}Examples:${NC}
  claw deploy --name bruce --bot-token "123:ABC..."
  claw auth bruce
  claw auth bruce --mode oauth
  claw list
  claw approve bruce 3R7YX6KS
  claw diagnose bruce
  claw fix bruce
  claw setup-amcp bruce
  claw config bruce --show
  claw checkpoint bruce
  claw shell bruce
  claw logs bruce -f
  claw destroy bruce

EOF
  exit 1
}

# =============================================================================
# Inline commands (too small to warrant their own script)
# =============================================================================

cmd_approve() {
  local name="${1:-}"
  local code="${2:-}"

  load_instance "$name" || exit 1
  [[ -z "$code" ]] && { echo "Usage: claw approve NAME CODE"; exit 1; }

  echo -e "${BLUE}Approving pairing code $code on $name...${NC}"

  ssh -i "$INSTANCE_SSH_KEY" $SSH_OPTS "${INSTANCE_SSH_USER}@$INSTANCE_IP" \
    "OPENCLAW_GATEWAY_TOKEN=\"${INSTANCE_GATEWAY_TOKEN}\" openclaw pairing approve telegram ${code} 2>&1"

  echo -e "${GREEN}OK Approved${NC}"
}

cmd_message() {
  local name="${1:-}"
  local msg="${2:-}"

  load_instance "$name" || exit 1
  [[ -z "$msg" ]] && { echo "Usage: claw message NAME \"text\""; exit 1; }

  ssh -i "$INSTANCE_SSH_KEY" $SSH_OPTS "${INSTANCE_SSH_USER}@$INSTANCE_IP" \
    "OPENCLAW_GATEWAY_TOKEN=\"${INSTANCE_GATEWAY_TOKEN}\" openclaw agent --session-id parent --message \"${msg//\"/\\\"}\" 2>&1"
}

cmd_logs() {
  local name="${1:?Usage: claw logs NAME [-f]}"
  local follow="${2:-}"

  load_instance "$name" || exit 1

  if [[ "$follow" == "-f" ]]; then
    ssh -i "$INSTANCE_SSH_KEY" $SSH_OPTS "${INSTANCE_SSH_USER}@$INSTANCE_IP" \
      "journalctl -u openclaw-gateway -f" 2>/dev/null
  else
    ssh -i "$INSTANCE_SSH_KEY" $SSH_OPTS "${INSTANCE_SSH_USER}@$INSTANCE_IP" \
      "journalctl -u openclaw-gateway --no-pager -n 50" 2>/dev/null
  fi
}

cmd_destroy() {
  local name="${1:-}"
  [[ -z "$name" ]] && { echo "Usage: claw destroy NAME"; exit 1; }

  echo -e "${YELLOW}Destroying $name...${NC}"
  "$SCRIPT_DIR/scripts/destroy.sh" "$name" --confirm
}

cmd_ssh() {
  local name="${1:?Usage: claw ssh NAME}"

  load_instance "$name" || exit 1

  echo -e "${CYAN}Connecting to $name ($INSTANCE_IP) as ${INSTANCE_SSH_USER}...${NC}"
  ssh -i "$INSTANCE_SSH_KEY" -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
    "${INSTANCE_SSH_USER}@$INSTANCE_IP"
}

cmd_shell() {
  local name="${1:?Usage: claw shell NAME}"

  load_instance "$name" || exit 1

  # Read Anthropic key from credentials or environment
  local credentials_file="$INSTANCES_DIR/credentials.json"
  local anthropic_key=""
  if [[ -f "$credentials_file" ]]; then
    anthropic_key=$(jq -r '.anthropic_api_key // empty' "$credentials_file")
  fi
  if [[ -z "$anthropic_key" ]]; then
    anthropic_key="${ANTHROPIC_API_KEY:-}"
  fi
  if [[ -z "$anthropic_key" ]]; then
    echo -e "${RED}No ANTHROPIC_API_KEY found in credentials or environment${NC}"
    exit 1
  fi

  echo -e "${CYAN}Opening Claude Code shell on $name ($INSTANCE_IP)...${NC}"

  # Detect workspace directory on VM, default to home
  local workspace
  workspace=$(ssh -i "$INSTANCE_SSH_KEY" $SSH_OPTS "${INSTANCE_SSH_USER}@$INSTANCE_IP" \
    "ls -d ~/.openclaw 2>/dev/null && echo ~/.openclaw || echo ~" 2>/dev/null)
  workspace=$(echo "$workspace" | tail -1 | tr -d '[:space:]')

  # SSH with TTY, set Anthropic key, cd to workspace, exec interactive Claude Code
  ssh -t -i "$INSTANCE_SSH_KEY" -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
    "${INSTANCE_SSH_USER}@$INSTANCE_IP" \
    "cd ${workspace} && ANTHROPIC_API_KEY='${anthropic_key}' claude --dangerously-skip-permissions"
}

# =============================================================================
# Main dispatcher
# =============================================================================

[[ $# -lt 1 ]] && usage

cmd="$1"
shift

case "$cmd" in
  deploy)      "$SCRIPT_DIR/deploy.sh" "$@" ;;
  import)      "$SCRIPT_DIR/scripts/import.sh" "$@" ;;
  list)        "$SCRIPT_DIR/scripts/list.sh" ;;
  status)      "$SCRIPT_DIR/scripts/status.sh" "$@" ;;
  diagnose)    "$SCRIPT_DIR/scripts/diagnose-remote.sh" "$@" ;;
  fix)         "$SCRIPT_DIR/scripts/fix-remote.sh" "$@" ;;
  approve)     cmd_approve "$@" ;;
  message)     cmd_message "$@" ;;
  logs)        cmd_logs "$@" ;;
  auth)        "$SCRIPT_DIR/scripts/auth.sh" "$@" ;;
  restart)     "$SCRIPT_DIR/scripts/restart.sh" "$@" ;;
  destroy)     cmd_destroy "$@" ;;
  upgrade)     "$SCRIPT_DIR/scripts/upgrade.sh" "$@" ;;
  setup-amcp)  "$SCRIPT_DIR/scripts/setup-amcp.sh" "$@" ;;
  config)      "$SCRIPT_DIR/scripts/remote-config.sh" "$@" ;;
  checkpoint)  "$SCRIPT_DIR/scripts/remote-checkpoint.sh" "$@" ;;
  shell)       cmd_shell "$@" ;;
  ssh)         cmd_ssh "$@" ;;
  help)        usage ;;
  *)           echo "Unknown command: $cmd"; usage ;;
esac
