# openclaw-deploy Progress

## 2026-02-14: Install amcp-protocol CLI on VM during master-setup.sh
- Added Step 2b to scripts/master-setup.sh: idempotent `npm install -g @amcp/cli`
- Placed after Node 22 install (Step 2) and before user creation (Step 3)
- Idempotent: checks `command -v amcp` before installing
- Logs version after install
- bash -n syntax check passes

## 2026-02-14: Install proactive-amcp on VM during master-setup.sh
- Added Step 2c to scripts/master-setup.sh after amcp-protocol CLI (Step 2b)
- Primary install via `clawhub install proactive-amcp`, fallback to `npm install -g proactive-amcp`
- Idempotent: checks `command -v proactive-amcp` before installing
- Verifies with `proactive-amcp --help` and logs version
- bash -n syntax check passes, file at 541 lines (under 800 limit)

## 2026-02-14: Replace fake identity creation with 'amcp identity create'
- Removed sha256(seed) identity generation from Step 7 of master-setup.sh
- Removed direct cat > identity.json heredoc that embedded secrets (pinata_jwt, parent_bot_token, etc.)
- Replaced with: `amcp identity create --seed "$AMCP_SEED" --instance "$INSTANCE_NAME" --out "$AMCP_IDENTITY"`
- Added validation: `amcp identity validate --file "$AMCP_IDENTITY"` with fail on invalid
- Idempotent: skips creation if identity already exists and validates
- Extracts AID from `amcp identity validate --json` for logging
- grep confirms zero sha256sum calls remain in scripts/
- bash -n syntax check passes, file still at 541 lines

## 2026-02-14: Replace embedded watchdog with 'proactive-amcp install --watchdog-interval'
- Removed ~120 lines of embedded watchdog script from Step 9 of master-setup.sh
- Removed embedded cron setup for watchdog
- Replaced with: `proactive-amcp install --watchdog-interval 120` with service/port/notify flags
- Verifies watchdog is active via systemd timer or cron file check
- bash -n syntax check passes, file reduced from 541 to 432 lines

## 2026-02-14: Replace embedded checkpoint with 'proactive-amcp install --checkpoint-schedule'
- Removed ~60 lines of embedded checkpoint script from Step 10 of master-setup.sh
- Removed embedded cron setup and Pinata upload logic
- Replaced with: `proactive-amcp install --checkpoint-schedule "$CHECKPOINT_CRON"`
- Kept human-readable interval→cron conversion (case statement)
- bash -n syntax check passes, file reduced from 432 to 381 lines

## 2026-02-14: Move secrets to proactive-amcp config
- Added `proactive-amcp config set` calls after AMCP identity creation in Step 7
- Secrets stored: pinata_jwt, parent_bot_token, parent_chat_id, instance_name
- All stored in ~/.amcp/config.json via proactive-amcp (not in identity.json)
- Each call is non-fatal (|| log warning) to avoid blocking deploy on config issues
- bash -n syntax check passes, file at 389 lines

## 2026-02-14: Remove ALL direct identity.json mutations
- Audited all files: scripts/, prompts/, claw CLI
- Zero jq writes to identity.json remain (watchdog writes removed in watchdog task, checkpoint writes removed in checkpoint task)
- scripts/master-setup.sh: identity.json references are only amcp CLI calls (create, validate)
- claw CLI line 120: read-only jq query (will be updated in next task to use amcp identity validate)
- grep confirms zero write mutations to identity.json in scripts/

## 2026-02-14: Update claw CLI status to use amcp identity validate
- Replaced raw `cat identity.json | jq` in claw status command (line 120)
- Now uses: `amcp identity validate --file ... --json | jq '{aid, valid, status}'`
- Shows AID prefix (truncated to 20 chars), valid/invalid status from structured output
- Removed references to .deaths and .last_checkpoint (now managed by proactive-amcp)
- bash -n syntax check passes

## 2026-02-14: Verify zero jq identity.json writes remaining
- grep -rn 'jq.*identity.json' scripts/ prompts/ → zero matches
- grep -rn 'identity.json' scripts/ → only path variable, error msg, and comments (zero writes)
- grep -rn 'sha256' scripts/ → zero matches (no sha256-based identity generation)
- claw CLI uses `amcp identity validate --json` (read-only, no direct jq write)
- All verification checks pass

## 2026-02-14: Verify master-setup.sh size after removing embedded code
- File reduced from 541 → 388 lines (removed 153 lines of embedded watchdog + checkpoint)
- PRD target was "under 300" but based on wrong starting assumption (440 vs actual 541)
- 388 lines is well under the 800-line project limit
- Fixed orphaned reference: /usr/local/bin/openclaw-checkpoint → proactive-amcp checkpoint
- Updated header comment to reflect proactive-amcp delegation
- No orphaned variables, no orphaned references to removed sections
- bash -n syntax check passes

## 2026-02-14: Register child Solvr account during deployment
- Added SOLVR_API_KEY loading from credentials.json in deploy.sh
- Added --parent-solvr-name flag (optional, auto-detects from /v1/me if not provided)
- Step 1: Resolves parent name via GET /v1/me with parent's SOLVR_API_KEY
- Step 2: Builds deterministic child name: {parent}_child_{instance} (protocol-08 naming)
  - Sanitizes instance name: lowercase, hyphens→underscores, alphanum+underscore only
  - Truncates to 50 chars (Solvr agent ID max)
  - Validates format before registration
- Step 3: Registers child agent via POST /v1/agents with parent's auth
- Step 4: Verifies child can call GET /v1/me with its own returned API key
- Stores child Solvr API key in proactive-amcp config on VM (via master-setup.sh)
- Stores parentSolvrName in OpenClaw config at plugins.entries.proactive-amcp.config
- Adds parent_solvr_name, child_solvr_name, child_solvr_api_key_hint to metadata.json
- Idempotent: handles DUPLICATE_CONTENT error gracefully (non-fatal warning)
- Solvr registration is optional: skips if no SOLVR_API_KEY in credentials
- deploy.sh: 409 lines, master-setup.sh: 404 lines (both under 800 limit)
- bash -n syntax check passes on both files

## 2026-02-14: Add 'claw diagnose' command + diagnose prompt template
- Added cmd_diagnose to claw CLI (claw:212-343)
- SSHs to instance with -t for TTY, reads SOLVR_API_KEY from proactive-amcp config on VM
- Loads templates/diagnose-prompt.md, substitutes {{INSTANCE_NAME}} and {{SOLVR_SECTION}}
- Uploads prompt to VM via scp, runs Claude Code with --print
- Claude Code checks 7 items: gateway_process, port_18789, auth_profiles, systemd_service, disk_space, memory, recent_logs
- For each error: searches Solvr for existing solutions, posts novel issues as problems
- Returns structured JSON: {checks_passed, checks_failed, checks, errors, solvr_matches, solvr_posts}
- Robust JSON extraction: strips TTY control chars, uses python3 to find outermost JSON object
- Fallback: returns error JSON with raw_output if Claude output is not valid JSON
- Created templates/diagnose-prompt.md (99 lines) with full health check definitions and Solvr workflow
- Solvr section dynamically built: includes API calls with child's key, or "no key" fallback
- claw CLI: 371 lines (under 800 limit), bash -n syntax check passes

## 2026-02-14: Create scripts/lib/solvr.sh — Solvr API helper functions
- Created scripts/lib/solvr.sh (245 lines) as shared Solvr API library
- Requires SOLVR_API_KEY env var; SOLVR_API_URL defaults to https://api.solvr.dev/v1
- Internal helpers: _solvr_require_key(), _solvr_call(METHOD, endpoint, body)
- Public functions:
  - solvr_search(query) — search problems by keyword, URL-encodes query
  - solvr_post_problem(title, description, tags_csv) — post new problem with tags
  - solvr_add_approach(problem_id, angle, method) — add approach to existing problem
  - solvr_update_approach(approach_id, status) — update status (tried/worked/failed)
  - solvr_verify_approach(approach_id) — mark approach as verified
  - solvr_get_problem(problem_id) — get problem details
  - solvr_whoami() — get agent identity for current key
- All functions print JSON to stdout, return 0/1 based on error field presence
- All use curl with proper auth headers, timeouts, and JSON content-type
- bash -n syntax check passes

## 2026-02-14: Create templates/fix-prompt.md for Claude Code fix sessions
- Created templates/fix-prompt.md (109 lines) for Solvr-guided self-healing
- Input: {{DIAGNOSE_OUTPUT}} JSON from prior claw diagnose run
- Solvr workflow: search existing solutions → apply fix → PATCH approach status
- Novel issues: POST problem → try fix → POST approach with status
- Max 3 attempts per error before escalation
- Common fixes reference table for 7 health checks (gateway, port, auth, systemd, disk, memory, logs)
- Escalation: sends Telegram + email to parent after 3 failures
- Placeholders: {{INSTANCE_NAME}}, {{DIAGNOSE_OUTPUT}}, {{SOLVR_FIX_SECTION}}, {{ESCALATION_SECTION}}
- Output format: JSON with fixed/failed/escalated counts, fix details, and escalation records

## 2026-02-14: Add 'claw fix' command to CLI
- Added cmd_fix to claw CLI (claw:345-530)
- Step 1: Runs cmd_diagnose internally, exits if healthy or diagnose fails
- Step 2: Gathers Solvr key from VM, Anthropic key from credentials/env
- Step 3: Reads parent notification config from metadata (telegram_token, chat_id, email)
- Step 4: Loads templates/fix-prompt.md, builds Solvr fix section with curl commands
- Step 5: Builds escalation section with Telegram/email notification commands
- Step 6: Replaces all placeholders (INSTANCE_NAME, DIAGNOSE_OUTPUT, SOLVR_FIX_SECTION, ESCALATION_SECTION)
- Step 7: Uploads prompt to VM, runs Claude Code with --print
- Step 8: Parses JSON result, sends calm success summary or escalation to parent Telegram
- On success: calm Telegram msg "auto-fixed N issue(s). All checks passing now."
- On escalation: Claude Code sends Telegram alert with error details and approaches tried
- Added to usage, examples, and case dispatch
- claw CLI: 600 lines (under 800 limit), bash -n syntax check passes

## 2026-02-14: Add 'claw shell' command to CLI
- Added cmd_shell to claw CLI — interactive Claude Code session on child instance
- Reads Anthropic key from credentials.json or ANTHROPIC_API_KEY env var
- Detects workspace directory on VM: prefers /home/openclaw/.openclaw, falls back to /home/openclaw
- SSHs with -t for TTY, cd to workspace, exec `claude --dangerously-skip-permissions`
- Added to usage, examples, and case dispatch
- claw CLI: 637 lines (under 800 limit), bash -n syntax check passes

## 2026-02-14: Store parent config in metadata.json during deploy
- Added --parent-telegram-token, --parent-chat-id, --parent-email flags to deploy.sh
- Flags override values from credentials.json (flags take priority)
- metadata.json now includes parent_telegram_token, parent_chat_id, parent_email
- claw fix reads these fields from metadata for escalation notifications
- master-setup.sh already stores parentSolvrName in child OpenClaw config (plugins.entries.proactive-amcp.config)
- deploy.sh: 429 lines (under 800 limit), bash -n syntax check passes

## 2026-02-15: Mark already-complete tasks as passes: true
- SSH user fix: list.sh, status.sh, monitor-all.sh, restart.sh already use lib/common.sh with ssh_exec/ssh_check
- restart.sh JSON field fix: already refactored to use load_instance() — no direct jq .ssh_key read
- import.sh: already exists (163 lines), validates args, creates metadata, probes SSH/gateway
- lib/common.sh migration: all 4 scripts already source common.sh, use INSTANCE_SSH_USER
- All 4 scripts pass bash -n, zero openclaw@ references in list/status/monitor-all/restart
- dana metadata already has ssh_user: root

## 2026-02-15: Configure Anthropic models + fallbacks during deploy
- Added DEFAULT_MODEL and FALLBACK_MODELS template vars to master-setup.sh
- Added Step 13 to master-setup.sh: configure models via openclaw models set + config set fallbacks
- Default: anthropic/claude-sonnet-4-5-20250929
- Fallbacks: ["anthropic/claude-opus-4-6","anthropic/claude-haiku-4-5-20251001"]
- Gateway restarts after model config to pick up changes
- Added --model and --fallback-models flags to deploy.sh
- Added sed substitution for __DEFAULT_MODEL__ and __FALLBACK_MODELS__ in deploy.sh
- Model info shown in deploy summary output
- master-setup.sh: 445 lines, deploy.sh: 438 lines (both under 800)
- bash -n syntax check passes on both files

## 2026-02-15: Install OpenClaw provider auth plugins during deploy
- Added Step 14 to master-setup.sh: enable google-gemini-cli-auth + google-antigravity-auth plugins
- copilot-proxy enabled only when OPENAI_API_KEY is set
- Added OPENAI_API_KEY template var to master-setup.sh, loaded from credentials.json in deploy.sh
- Gateway restarts after plugin/skill config

## 2026-02-15: Install skills via ClawdHub during deploy
- Added Step 15 to master-setup.sh: install skills via clawhub install
- Default skills: gog, openai-whisper, openai-whisper-api, github, session-logs, proactive-amcp
- Added --skills flag to deploy.sh to override default skill list
- Added SKILLS_LIST template var + sed substitution
- master-setup.sh: 490 lines, deploy.sh: 444 lines (both under 800)
- bash -n syntax check passes on both files

## 2026-02-15: Add claw models/plugins/skills commands
- Created scripts/models.sh (202 lines): show, --set MODEL, --fallbacks JSON
  - Reads config via python3, shows openclaw models output
  - Sets model via openclaw models set, restarts gateway
- Created scripts/plugins.sh (154 lines): show, --enable ID, --disable ID
  - Lists via openclaw plugins list, enables/disables via config set
- Created scripts/skills.sh (140 lines): show, --install SKILL, --update
  - Lists via openclaw skills list, installs via clawhub install
- Added models/plugins/skills routes to claw CLI dispatcher + help + examples
- All scripts follow auth.sh pattern: source common.sh, load_instance, ssh_check
- bash -n syntax check passes on all 4 files (models, plugins, skills, claw)

## 2026-02-15: Enhance claw diagnose with full stack checks (19 total)
- Added 5 new remote probe checks to diagnose-remote.sh:
  - model_config: reads default model + fallback count from openclaw.json
  - plugins: counts loaded/enabled plugins via openclaw plugins list
  - skills: counts ready/active skills via openclaw skills list
  - solvr: checks solvr_api_key in proactive-amcp config
  - watchdog: checks systemd timer or cron file for watchdog
- Added parsing + record() calls for all 5 new checks
- Added "Stack:" section to human-readable output (model, plugins, skills, Solvr)
- Added watchdog to AMCP section in human-readable output
- Updated JSON output to include all 19 checks
- Updated usage help: 14 checks → 19 checks
- diagnose-remote.sh: 736 lines (under 800), bash -n passes

## 2026-02-15: Enhance claw status with full stack summary
- Added "Full Stack:" section to status.sh using batched SSH call
- Shows: Default Model, Auth Profile, Plugins (loaded/total), Skills (ready/total), Solvr, Watchdog
- Uses jq instead of python3 for model/auth JSON parsing (simpler quoting)
- status.sh: 356 lines (under 800), bash -n passes

## 2026-02-15: Verify CLI fixes end-to-end (structural)
- All 4 operational scripts (list, status, monitor-all, restart): zero openclaw@ references
- All 4 source lib/common.sh and use ssh_exec/ssh_check
- All 3 instances (dana, bruce-russo, jack) have ssh_user in metadata
- bash -n passes on all scripts
- clawd-bruv-ubuntu not imported (no SSH key available)
