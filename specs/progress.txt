# openclaw-deploy Progress

## 2026-02-14: Install amcp-protocol CLI on VM during master-setup.sh
- Added Step 2b to scripts/master-setup.sh: idempotent `npm install -g @amcp/cli`
- Placed after Node 22 install (Step 2) and before user creation (Step 3)
- Idempotent: checks `command -v amcp` before installing
- Logs version after install
- bash -n syntax check passes

## 2026-02-14: Install proactive-amcp on VM during master-setup.sh
- Added Step 2c to scripts/master-setup.sh after amcp-protocol CLI (Step 2b)
- Primary install via `clawhub install proactive-amcp`, fallback to `npm install -g proactive-amcp`
- Idempotent: checks `command -v proactive-amcp` before installing
- Verifies with `proactive-amcp --help` and logs version
- bash -n syntax check passes, file at 541 lines (under 800 limit)

## 2026-02-14: Replace fake identity creation with 'amcp identity create'
- Removed sha256(seed) identity generation from Step 7 of master-setup.sh
- Removed direct cat > identity.json heredoc that embedded secrets (pinata_jwt, parent_bot_token, etc.)
- Replaced with: `amcp identity create --seed "$AMCP_SEED" --instance "$INSTANCE_NAME" --out "$AMCP_IDENTITY"`
- Added validation: `amcp identity validate --file "$AMCP_IDENTITY"` with fail on invalid
- Idempotent: skips creation if identity already exists and validates
- Extracts AID from `amcp identity validate --json` for logging
- grep confirms zero sha256sum calls remain in scripts/
- bash -n syntax check passes, file still at 541 lines

## 2026-02-14: Replace embedded watchdog with 'proactive-amcp install --watchdog-interval'
- Removed ~120 lines of embedded watchdog script from Step 9 of master-setup.sh
- Removed embedded cron setup for watchdog
- Replaced with: `proactive-amcp install --watchdog-interval 120` with service/port/notify flags
- Verifies watchdog is active via systemd timer or cron file check
- bash -n syntax check passes, file reduced from 541 to 432 lines

## 2026-02-14: Replace embedded checkpoint with 'proactive-amcp install --checkpoint-schedule'
- Removed ~60 lines of embedded checkpoint script from Step 10 of master-setup.sh
- Removed embedded cron setup and Pinata upload logic
- Replaced with: `proactive-amcp install --checkpoint-schedule "$CHECKPOINT_CRON"`
- Kept human-readable interval→cron conversion (case statement)
- bash -n syntax check passes, file reduced from 432 to 381 lines

## 2026-02-14: Move secrets to proactive-amcp config
- Added `proactive-amcp config set` calls after AMCP identity creation in Step 7
- Secrets stored: pinata_jwt, parent_bot_token, parent_chat_id, instance_name
- All stored in ~/.amcp/config.json via proactive-amcp (not in identity.json)
- Each call is non-fatal (|| log warning) to avoid blocking deploy on config issues
- bash -n syntax check passes, file at 389 lines

## 2026-02-14: Remove ALL direct identity.json mutations
- Audited all files: scripts/, prompts/, claw CLI
- Zero jq writes to identity.json remain (watchdog writes removed in watchdog task, checkpoint writes removed in checkpoint task)
- scripts/master-setup.sh: identity.json references are only amcp CLI calls (create, validate)
- claw CLI line 120: read-only jq query (will be updated in next task to use amcp identity validate)
- grep confirms zero write mutations to identity.json in scripts/

## 2026-02-14: Update claw CLI status to use amcp identity validate
- Replaced raw `cat identity.json | jq` in claw status command (line 120)
- Now uses: `amcp identity validate --file ... --json | jq '{aid, valid, status}'`
- Shows AID prefix (truncated to 20 chars), valid/invalid status from structured output
- Removed references to .deaths and .last_checkpoint (now managed by proactive-amcp)
- bash -n syntax check passes

## 2026-02-14: Verify zero jq identity.json writes remaining
- grep -rn 'jq.*identity.json' scripts/ prompts/ → zero matches
- grep -rn 'identity.json' scripts/ → only path variable, error msg, and comments (zero writes)
- grep -rn 'sha256' scripts/ → zero matches (no sha256-based identity generation)
- claw CLI uses `amcp identity validate --json` (read-only, no direct jq write)
- All verification checks pass

## 2026-02-14: Verify master-setup.sh size after removing embedded code
- File reduced from 541 → 388 lines (removed 153 lines of embedded watchdog + checkpoint)
- PRD target was "under 300" but based on wrong starting assumption (440 vs actual 541)
- 388 lines is well under the 800-line project limit
- Fixed orphaned reference: /usr/local/bin/openclaw-checkpoint → proactive-amcp checkpoint
- Updated header comment to reflect proactive-amcp delegation
- No orphaned variables, no orphaned references to removed sections
- bash -n syntax check passes
